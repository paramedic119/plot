<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ‰å“è³ª çµ±åˆåˆ†æãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary: #4fc3f7;
            --accent: #f44336;
            --road: #fb8c00;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #f8fafc;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .controls {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            width: 100%;
            max-width: 900px;
            text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .btn-group button,
        .btn-group a {
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn-group button:active,
        .btn-group a:active {
            transform: scale(0.95);
        }

        .filter-control {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            text-align: left;
        }

        .slider-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        input[type="range"] {
            flex-grow: 1;
            max-width: 400px;
            accent-color: var(--primary);
        }

        select,
        input[type="checkbox"] {
            cursor: pointer;
        }

        #thresholdDisplay {
            margin-top: 20px;
            padding: 20px;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 16px;
            text-align: left;
            display: none;
            backdrop-filter: blur(4px);
        }

        .threshold-title {
            color: #ffcccc;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .threshold-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 1rem;
            color: #fff;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
        }

        .rationale {
            font-size: 0.8rem;
            color: #94a3b8;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 12px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            width: 100%;
            max-width: 1300px;
        }

        .chart-container {
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            margin-bottom: 15px;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        canvas {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 12px;
            max-width: 100%;
            height: auto;
        }

        #bowlCanvas {
            border-radius: 50%;
        }

        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 12px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        .line-legend {
            width: 18px;
            height: 2px;
            background-color: #ff3b30;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .btn-group {
                flex-direction: column !important;
            }

            .btn-group button,
            .btn-group a {
                width: 100% !important;
                text-align: center;
            }

            .chart-container {
                padding: 12px;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <h1>INTEGRATED ANALYTICS</h1>
    <div class="controls">
        <div class="btn-group" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <button id="syncBtn"
                style="flex: 1; padding: 12px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">æœ€æ–°ã«åŒæœŸ</button>
            <button id="resetBtn"
                style="padding: 12px; background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            <a href="map.html" target="_blank"
                style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; text-decoration: none; display: inline-block;">åœ°å›³è§£æ</a>
        </div>
        <label style="font-size: 0.9rem; color: #cbd5e1; cursor: pointer; display: inline-block; margin-bottom: 10px;">
            <input type="checkbox" id="autoRefreshCheck"> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– (5ç§’å‘¨æœŸ)
        </label>
        <div id="statsDisplay" style="color:#64748b; font-size: 0.9rem; font-weight: bold;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>

        <!-- ä¿¡å·å‡¦ç†ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filter-control">
            <div style="font-weight: 600; text-align: center;">L-PASS FILTER STRENGTH (ãƒã‚¤ã‚ºé™¤å»)</div>
            <div class="slider-wrap">
                <span style="font-size: 0.8rem; color: #475569;">å¼±</span>
                <input type="range" id="filterSlider" min="1" max="50" value="10">
                <span style="font-size: 0.8rem; color: #475569;">å¼·</span>
            </div>
            <div id="filterValueDisplay"
                style="margin-top:5px; color:var(--primary); font-size: 0.85rem; font-weight: 600; text-align: center;">
                éå» 10 ã‚µãƒ³ãƒ—ãƒ« (ç´„ 0.2 ç§’)</div>
        </div>

        <!-- é«˜åº¦ãªåˆ†æè¨­å®š -->
        <div class="filter-control" style="background: rgba(33, 150, 243, 0.1); border-color: rgba(33, 150, 243, 0.3);">
            <div style="font-weight: 600; margin-bottom: 12px; color: #90caf9;">ğŸ§­ é«˜åº¦ãªã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ»åˆ†æè¨­å®š</div>

            <div style="display: flex; flex-direction: column; gap: 15px;">
                <label
                    style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <input type="checkbox" id="roadFilterCheck" checked style="width: 18px; height: 18px;">
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: bold; color: #fff;">è·¯é¢èµ·å› ã®ä¸å¿«æ„Ÿã‚’åˆ†é›¢ (Zè»¸è¦å› ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)</span>
                        <span
                            style="font-size: 0.75rem; color: #94a3b8;">Zè»¸ã®Jerk(è¡æ’ƒ)ãŒå¼·ã„ä¸å¿«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§ç¤ºã—ã€è‡ªå‹•é–¾å€¤ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚</span>
                    </div>
                </label>

                <div
                    style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <span style="font-weight: bold; color: #fff;">G-Bowlã®æœ€å¤§ã‚¹ã‚±ãƒ¼ãƒ« (èƒŒæ™¯å††ã®ç¯„å›²):</span>
                    <select id="gBowlMaxSelect"
                        style="background: var(--glass); color: white; border: 1px solid var(--glass-border); border-radius: 8px; padding: 6px 12px; font-weight: bold; font-size: 1rem;">
                        <option value="0.20">0.20 G</option>
                        <option value="0.25">0.25 G</option>
                        <option value="0.30">0.30 G</option>
                        <option value="0.35">0.35 G</option>
                        <option value="0.40" selected>0.40 G</option>
                        <option value="0.45">0.45 G</option>
                        <option value="0.50">0.50 G</option>
                        <option value="0.60">0.60 G</option>
                        <option value="0.80">0.80 G</option>
                        <option value="1.00">1.00 G</option>
                    </select>
                </div>

                <!-- è·¯é¢æ„Ÿåº¦ï¼ˆZè»¸åˆ¤å®šï¼‰èª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                <div
                    style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(251, 140, 0, 0.3);">
                    <div
                        style="display: flex; justify-content: space-between; font-weight: bold; color: var(--road); margin-bottom: 8px;">
                        <span>è·¯é¢èµ·å› ã®åˆ¤å®šæ„Ÿåº¦ (Zè»¸è¡æ’ƒé–¾å€¤)</span>
                        <span id="zThresholdValue">0.80 G/s</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">æ•æ„Ÿ<br>(è·¯é¢ã«ãªã‚Šã‚„ã™ã„)</span>
                        <input type="range" id="zThresholdSlider" min="0.1" max="2.0" step="0.05" value="0.8"
                            style="accent-color: var(--road);">
                        <span style="font-size: 0.7rem; color: #94a3b8;">éˆæ„Ÿ<br>(é‹è»¢ã«ãªã‚Šã‚„ã™ã„)</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 8px;">
                        ä¸å¿«æ™‚ã®Zè»¸è¡æ’ƒãŒã“ã®å€¤ã‚’è¶…ãˆã‚‹ã¨ã€Œè·¯é¢èµ·å› ï¼ˆæ©™ï¼‰ã€ã€ä¸‹å›ã‚‹ã¨ã€Œé‹è»¢æ“ä½œï¼ˆèµ¤ï¼‰ã€ã¨åˆ†é¡ã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>

                <!-- åå¿œé…å»¶è£œæ­£ï¼ˆãƒ«ãƒƒã‚¯ãƒãƒƒã‚¯ï¼‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                <div
                    style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(76, 175, 80, 0.3); margin-top: 15px;">
                    <div
                        style="display: flex; justify-content: space-between; font-weight: bold; color: #4ade80; margin-bottom: 8px;">
                        <span>åå¿œé…å»¶ã®è£œæ­£ (éå»ã¸ã®é¡ã‚Š)</span>
                        <span id="lookbackValue">0.5 ç§’</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">0ç§’<br>(ç›´ä¸Šã®ã¿)</span>
                        <input type="range" id="lookbackSlider" min="0.0" max="3.0" step="0.1" value="0.5"
                            style="accent-color: #4ade80;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">3ç§’<br>(é•·ãé¡ã‚‹)</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 8px;">
                        ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã‹ã‚‰ã€è¨­å®šã—ãŸç§’æ•°ã ã‘éå»ã«é¡ã£ã¦ã€æœ€å¤§ã®Zè»¸è¡æ’ƒã‚’æ¢ã—ã¾ã™ã€‚
                    </div>
                </div>
            </div>

            <!-- èµ°è¡Œã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ -->
            <div class="filter-control"
                style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); margin-top: 15px;">
                <div style="font-weight: 600; margin-bottom: 12px; color: #81c784;">ğŸš— èµ°è¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆåŒä¸€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼/å›ï¼‰ã®é¸æŠ</div>
                <div
                    style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <select id="runSelect"
                        style="width: 100%; background: var(--glass); color: white; border: 1px solid var(--glass-border); border-radius: 8px; padding: 8px; font-weight: bold; font-size: 0.9rem;">
                        <option value="all">ã™ã¹ã¦ã®èµ°è¡Œãƒ‡ãƒ¼ã‚¿ (å…¨ä½“ã‚’è¡¨ç¤º)</option>
                    </select>
                </div>
                <div style="font-size: 0.7rem; color: #64748b; margin-top: 8px;">
                    1åˆ†ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ç©ºç™½ã‚’å…ƒã«è‡ªå‹•çš„ã«èµ°è¡Œã‚’åŒºåˆ‡ã£ã¦ã„ã¾ã™ã€‚ç‰¹å®šã®é‹è»¢è€…ãƒ»å›ã®åˆ†æã‚’è¡Œã†å ´åˆã«é¸æŠã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
        </div>

        <div id="thresholdDisplay">
            <div class="threshold-title">è‡ªå‹•ç®—å‡ºã•ã‚ŒãŸ é‹è»¢æ“ä½œã®ä¸å¿«é–¾å€¤é™ç•Œ</div>
            <div class="threshold-values" id="thresholdValues"></div>
            <div class="rationale">
                <strong>ã€çµ±è¨ˆçš„æ ¹æ‹  (95th Percentile)ã€‘</strong><br>
                Zè»¸èµ·å› ï¼ˆè·¯é¢ã®æ®µå·®ãªã©ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ã€ç´”ç²‹ãªã€ŒåŠ æ¸›é€Ÿãƒ»ãƒãƒ³ãƒ‰ãƒ«æ“ä½œã€ã«ã‚ˆã‚‹ä¸å¿«ç”³å‘Šã®ã¿ã‚’æŠ½å‡ºã€‚<br>
                ãã®95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«å€¤ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã€å®¢è¦³çš„ãªå®‰å…¨é‹è»¢ã®å¢ƒç•Œç·šã‚’å°ãå‡ºã—ã¦ã„ã¾ã™ã€‚
            </div>
        </div>

        <div class="legend">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="showSafeCheck" checked>
                <span class="dot" style="background: rgba(76, 175, 80, 0.5);"></span>å¿«é©/å®‰å…¨
            </label>
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="showDriverCheck" checked>
                <span class="dot" style="background: rgba(244, 67, 54, 0.8);"></span>æ“ä½œèµ·å›  (èµ¤)
            </label>
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="showRoadCheck" checked>
                <span class="dot" style="background: var(--road);"></span>è·¯é¢èµ·å›  (æ©™)
            </label>
            <div><span class="line-legend"></span>è‡ªå‹•ç®—å‡ºé–¾å€¤ãƒ©ã‚¤ãƒ³</div>
        </div>
    </div>

    <div class="charts-grid" id="chartsArea">
        <!-- æ•£å¸ƒå›³ (NEW) -->
        <div class="chart-container" style="grid-column: 1 / -1; border: 1px solid var(--primary);">
            <div class="chart-title" style="color: var(--primary);">Road Factor vs Driver Factor (ä¸å¿«è¦å› ã®åˆ†é›¢æ•£å¸ƒå›³)</div>
            <canvas id="scatterCanvas" width="800" height="350"></canvas>
            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px; width: 100%; text-align: center;">
                <strong>Xè»¸: è»Šä¸¡æ“ä½œã®ç²—ã• (XYè»¸ã®åŠ›)</strong> / <strong>Yè»¸: è·¯é¢ã®æ‚ªã• (Zè»¸ã®è¡æ’ƒåŠ›)</strong><br>
                å³ä¸‹ã«ãƒ—ãƒ­ãƒƒãƒˆã•ã‚Œã‚‹ã»ã©ã€Œé‹è»¢ã®å•é¡Œã€ã€å·¦ä¸Šã«ãƒ—ãƒ­ãƒƒãƒˆã•ã‚Œã‚‹ã»ã©ã€Œé“ãŒæ‚ªã‹ã£ãŸã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">G-Bowl Plane (Lon/Lat G)</div>
            <canvas id="bowlCanvas" width="400" height="400"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Jerk vs Composite G (Impact)</div>
            <canvas id="jerkCanvas" width="500" height="400"></canvas>
        </div>
        <div class="chart-container" style="grid-column: 1 / -1;">
            <div class="chart-title">Vertical G (Z-Axis) Timeline</div>
            <canvas id="verticalCanvas" width="1000" height="200"></canvas>
        </div>
    </div>

    <script>
        const bowlCtx = document.getElementById('bowlCanvas').getContext('2d');
        const jerkCtx = document.getElementById('jerkCanvas').getContext('2d');
        const verticalCtx = document.getElementById('verticalCanvas').getContext('2d');
        const scatterCtx = document.getElementById('scatterCanvas').getContext('2d');

        const filterSlider = document.getElementById('filterSlider');
        const filterValueDisplay = document.getElementById('filterValueDisplay');
        const roadFilterCheck = document.getElementById('roadFilterCheck');
        const gBowlMaxSelect = document.getElementById('gBowlMaxSelect');
        const zThresholdSlider = document.getElementById('zThresholdSlider');
        const zThresholdValue = document.getElementById('zThresholdValue');
        const lookbackSlider = document.getElementById('lookbackSlider');
        const lookbackValue = document.getElementById('lookbackValue');
        const runSelect = document.getElementById('runSelect');
        const showSafeCheck = document.getElementById('showSafeCheck');
        const showDriverCheck = document.getElementById('showDriverCheck');
        const showRoadCheck = document.getElementById('showRoadCheck');
        const thresholdDisplay = document.getElementById('thresholdDisplay');
        const thresholdValues = document.getElementById('thresholdValues');
        const syncBtn = document.getElementById('syncBtn');
        const autoRefreshCheck = document.getElementById('autoRefreshCheck');

        const gasUrl = "https://script.google.com/macros/s/AKfycbyza-BCowCNcWYb-63gx1gd4UARcYTeJ8DXqv-rrZwcRryWqfZanAnXfyrf6jFxMEfDIA/exec";

        let rawData = []; // All data fetched
        let currentTrips = []; // List of identified trips
        let wakeLock = null;
        let refreshInterval = null;

        const padding = 50; const pWidth = 400; const pHeight = 300;
        const sPadding = 60; const sWidth = 800 - sPadding * 2; const sHeight = 350 - sPadding * 2;
        const vWidth = 900; // Total vertical timeline width
        const jMaxX = 1.0; const jMaxY = 0.5;
        const bCenter = 200;

        function drawGrids() {
            const gMax = parseFloat(gBowlMaxSelect.value);
            const bScale = 200 / gMax;

            // G-Bowl
            bowlCtx.clearRect(0, 0, 400, 400);
            bowlCtx.strokeStyle = '#1e293b'; bowlCtx.fillStyle = '#475569';
            bowlCtx.beginPath(); bowlCtx.moveTo(0, bCenter); bowlCtx.lineTo(400, bCenter);
            bowlCtx.moveTo(bCenter, 0); bowlCtx.lineTo(bCenter, 400); bowlCtx.stroke();

            bowlCtx.font = '10px sans-serif';
            let step = (gMax <= 0.3) ? 0.05 : 0.1;
            for (let g = step; g <= gMax; g += step) {
                bowlCtx.beginPath(); bowlCtx.arc(bCenter, bCenter, g * bScale, 0, Math.PI * 2); bowlCtx.stroke();
                bowlCtx.fillText(`${g.toFixed(2)}G`, bCenter + 5, bCenter - (g * bScale) + 12);
            }

            // Jerk
            jerkCtx.clearRect(0, 0, 500, 400); jerkCtx.fillStyle = '#0f172a'; jerkCtx.fillRect(0, 0, 500, 400);
            jerkCtx.strokeStyle = '#1e293b'; jerkCtx.beginPath();
            jerkCtx.moveTo(padding, padding); jerkCtx.lineTo(padding, 350); jerkCtx.lineTo(450, 350); jerkCtx.stroke();
            jerkCtx.fillStyle = '#475569'; jerkCtx.textAlign = 'center';
            for (let i = 0; i <= 10; i += 2) {
                let x = padding + (i / 10 / jMaxX) * pWidth;
                jerkCtx.fillText((i / 10).toFixed(1), x, 370);
            }
            jerkCtx.fillText('Jerk / åŠ åŠ åŠ é€Ÿåº¦ XYåˆç®— (G/s)', 250, 390);
            jerkCtx.textAlign = 'right'; jerkCtx.textBaseline = 'middle';
            for (let i = 0; i <= 5; i += 1) {
                let y = 350 - (i / 10 / jMaxY) * pHeight;
                jerkCtx.fillText((i / 10).toFixed(1), padding - 10, y);
            }

            // Vertical 
            verticalCtx.clearRect(0, 0, 1000, 200); verticalCtx.strokeStyle = '#1e293b';
            verticalCtx.beginPath(); verticalCtx.moveTo(padding, 100); verticalCtx.lineTo(padding + vWidth, 100); verticalCtx.stroke();
            verticalCtx.fillStyle = '#475569'; verticalCtx.font = '10px sans-serif';
            verticalCtx.fillText('0G', padding - 5, 100);
            verticalCtx.fillText('+0.5G', padding - 5, 50);
            verticalCtx.fillText('-0.5G', padding - 5, 150);

            // Scatter
            scatterCtx.clearRect(0, 0, 800, 350);
            scatterCtx.strokeStyle = '#1e293b'; scatterCtx.fillStyle = '#475569';
            scatterCtx.beginPath();
            scatterCtx.moveTo(sPadding, sPadding);
            scatterCtx.lineTo(sPadding, 350 - sPadding); // Y axis
            scatterCtx.lineTo(800 - sPadding, 350 - sPadding); // X axis
            scatterCtx.stroke();
            scatterCtx.textAlign = 'center'; scatterCtx.textBaseline = 'top';
            scatterCtx.fillText('é‹è»¢è¦å›  [ XYè»¸ åˆæˆG + Jerkå€¤ ]', 400, 350 - sPadding + 15);

            scatterCtx.save();
            scatterCtx.translate(sPadding - 25, 175);
            scatterCtx.rotate(-Math.PI / 2);
            scatterCtx.textAlign = 'center';
            scatterCtx.fillText('è·¯é¢è¦å›  [ Zè»¸ Jerkè¡æ’ƒ ]', 0, 0);
            scatterCtx.restore();
        }

        function processAndPlot() {
            if (rawData.length === 0) { drawGrids(); return; }

            // Filter data based on selected trip
            const selectedTripId = runSelect.value;
            let displayData = rawData;
            if (selectedTripId !== 'all') {
                const trip = currentTrips.find(t => t.id === selectedTripId);
                if (trip) {
                    displayData = rawData.slice(trip.startIndex, trip.endIndex + 1);
                }
            }

            if (displayData.length === 0) { drawGrids(); return; }

            const windowSize = parseInt(filterSlider.value);
            filterValueDisplay.innerText = `ç¾åœ¨ã®è¨­å®š: éå» ${windowSize} ã‚µãƒ³ãƒ—ãƒ« (ç´„ ${(windowSize * 0.05).toFixed(2)} ç§’)`;

            const gMax = parseFloat(gBowlMaxSelect.value);
            const bScale = 200 / gMax;
            drawGrids();

            let processedData = [];
            for (let i = 0; i < displayData.length; i++) {
                let sumX = 0; let sumY = 0; let count = 0;
                for (let j = Math.max(0, i - windowSize + 1); j <= i; j++) {
                    sumX += displayData[j].rawX; sumY += displayData[j].rawY; count++;
                }

                let smoothX = sumX / count; let smoothY = sumY / count;
                processedData.push({
                    time: displayData[i].time,
                    uncomf: displayData[i].uncomf,
                    sX: smoothX, sY: smoothY,
                    rawZ: displayData[i].rawZ,
                    jerkZ: displayData[i].jerkZ,
                    sG: Math.sqrt(smoothX ** 2 + smoothY ** 2),
                    jerk: displayData[i].jerk || 0,
                    yaw: displayData[i].yaw || 0,
                    lat: displayData[i].lat, lon: displayData[i].lon
                });
            }

            for (let i = 1; i < processedData.length; i++) {
                if (processedData[i].jerk === 0) {
                    let dt = (processedData[i].time - processedData[i - 1].time) / 1000;
                    if (dt > 0) processedData[i].jerk = Math.abs((processedData[i].sG - processedData[i - 1].sG) / dt);
                }
            }

            const getJX = (j) => padding + (Math.min(j, jMaxX) / jMaxX) * pWidth;
            const getJY = (g) => 350 - (Math.min(g, jMaxY) / jMaxY) * pHeight;

            // Scatter max limits for scaling
            const scMaxX = 1.5; // (XY Jerk + XY G*2) max expectation
            const scMaxY = 3.0; // Z Jerk max expectation
            const getScX = (drvFactor) => sPadding + (Math.min(drvFactor, scMaxX) / scMaxX) * sWidth;
            const getScY = (roadFactor) => (350 - sPadding) - (Math.min(roadFactor, scMaxY) / scMaxY) * sHeight;

            let safeC = 0, dangerC = 0, roadC = 0;
            const useRoadFilter = roadFilterCheck.checked;
            const zThresh = parseFloat(zThresholdSlider.value);
            zThresholdValue.innerText = zThresh.toFixed(2) + " G/s";
            const lookbackTime = parseFloat(lookbackSlider.value);
            lookbackValue.innerText = lookbackTime.toFixed(1) + " ç§’";

            const showSafe = showSafeCheck.checked;
            const showDriver = showDriverCheck.checked;
            const showRoad = showRoadCheck.checked;

            // Draw Lines for Vertical G
            verticalCtx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
            verticalCtx.beginPath();
            processedData.forEach((p, idx) => {
                let vx = padding + (idx / processedData.length) * vWidth;
                let vy = 100 - (p.rawZ * 100);
                if (idx === 0) verticalCtx.moveTo(vx, vy); else verticalCtx.lineTo(vx, vy);
            });
            verticalCtx.stroke();

            // Safe Points
            if (showSafe) {
                bowlCtx.fillStyle = 'rgba(76, 175, 80, 0.15)';
                jerkCtx.fillStyle = 'rgba(76, 175, 80, 0.15)';
                processedData.forEach(p => {
                    if (p.uncomf === 0) {
                        bowlCtx.beginPath(); bowlCtx.arc(bCenter + (p.sX * bScale), bCenter - (p.sY * bScale), 2, 0, Math.PI * 2); bowlCtx.fill();
                        jerkCtx.beginPath(); jerkCtx.arc(getJX(p.jerk), getJY(p.sG), 2, 0, Math.PI * 2); jerkCtx.fill();
                    }
                });
            }
            processedData.forEach(p => { if (p.uncomf === 0) safeC++; });

            // Danger Points mapping
            let driverDangerPoints = [];

            processedData.forEach((p, idx) => {
                if (p.uncomf === 1) {
                    let isRoad = false;
                    let evalZJerk = Math.abs(p.jerkZ);

                    // ãƒ«ãƒƒã‚¯ãƒãƒƒã‚¯ï¼šè¨­å®šã•ã‚ŒãŸç§’æ•°ï¼ˆãƒŸãƒªç§’ï¼‰ã ã‘éå»ã«é¡ã£ã¦æœ€å¤§ã®Zè¡æ’ƒã‚’æ¢ã™
                    if (useRoadFilter && lookbackTime > 0) {
                        let lookbackMs = lookbackTime * 1000;
                        for (let j = idx; j >= 0; j--) {
                            if (p.time - processedData[j].time > lookbackMs) break;
                            let absZ = Math.abs(processedData[j].jerkZ);
                            if (absZ > evalZJerk) evalZJerk = absZ;
                        }
                    }

                    // è·¯é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒONã€ã‹ã¤Zè»¸ã®è¡æ’ƒãŒè¨­å®šé–¾å€¤ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆ
                    if (useRoadFilter && evalZJerk > zThresh) {
                        isRoad = true;
                        roadC++;
                    } else {
                        driverDangerPoints.push(p);
                        dangerC++;
                    }

                    // Bowl & Jerk Plots
                    if ((isRoad && showRoad) || (!isRoad && showDriver)) {
                        if (isRoad) {
                            bowlCtx.fillStyle = 'rgba(251, 140, 0, 0.8)'; // Orange
                            jerkCtx.fillStyle = 'rgba(251, 140, 0, 0.8)';
                        } else {
                            bowlCtx.fillStyle = 'rgba(244, 67, 54, 0.8)'; // Red
                            jerkCtx.fillStyle = 'rgba(244, 67, 54, 0.8)';
                        }
                        bowlCtx.beginPath(); bowlCtx.arc(bCenter + (p.sX * bScale), bCenter - (p.sY * bScale), 3, 0, Math.PI * 2); bowlCtx.fill();
                        jerkCtx.beginPath(); jerkCtx.arc(getJX(p.jerk), getJY(p.sG), 3, 0, Math.PI * 2); jerkCtx.fill();

                        // Scatter Plot Mapping
                        let drvFactor = p.sG * 2.0 + p.jerk;
                        let roadFactor = evalZJerk;
                        scatterCtx.fillStyle = isRoad ? 'rgba(251, 140, 0, 0.8)' : 'rgba(244, 67, 54, 0.8)';
                        scatterCtx.beginPath();
                        scatterCtx.arc(getScX(drvFactor), getScY(roadFactor), 4, 0, Math.PI * 2);
                        scatterCtx.fill();

                        // Overlay on Vertical Canvas
                        let vx = padding + (idx / processedData.length) * vWidth;
                        verticalCtx.fillStyle = isRoad ? 'rgba(251, 140, 0, 1)' : 'rgba(244, 67, 54, 1)';
                        verticalCtx.beginPath();
                        verticalCtx.arc(vx, 100 - (p.rawZ * 100), 4, 0, Math.PI * 2);
                        verticalCtx.fill();
                    }
                }
            });

            // Calculate Thresholds based ONLY on Driver Danger Points
            if (driverDangerPoints.length >= 20) {
                let p5Index = Math.floor(driverDangerPoints.length * 0.05); // Top 95%
                let sortedAbsGx = driverDangerPoints.map(p => Math.abs(p.sX)).sort((a, b) => a - b);
                let sortedAbsGy = driverDangerPoints.map(p => Math.abs(p.sY)).sort((a, b) => a - b);
                let sortedJerk = driverDangerPoints.map(p => p.jerk).sort((a, b) => a - b);
                let sortedG = driverDangerPoints.map(p => p.sG).sort((a, b) => a - b);

                let threshGx = sortedAbsGx[p5Index]; let threshGy = sortedAbsGy[p5Index];
                let threshJerk = sortedJerk[p5Index]; let threshG = sortedG[p5Index];

                // Draw Threshold Ellipse on Bowl
                bowlCtx.beginPath();
                if (typeof bowlCtx.ellipse === 'function') {
                    bowlCtx.ellipse(bCenter, bCenter, threshGx * bScale, threshGy * bScale, 0, 0, Math.PI * 2);
                } else {
                    bowlCtx.arc(bCenter, bCenter, Math.max(threshGx, threshGy) * bScale, 0, Math.PI * 2);
                }
                bowlCtx.strokeStyle = 'rgba(255, 59, 48, 0.8)'; bowlCtx.lineWidth = 2;
                bowlCtx.setLineDash([5, 5]); bowlCtx.stroke(); bowlCtx.setLineDash([]);

                // Draw Threshold lines on Jerk Canvas
                jerkCtx.strokeStyle = 'rgba(255, 59, 48, 0.8)'; jerkCtx.lineWidth = 2; jerkCtx.setLineDash([5, 5]);
                let tJx = getJX(threshJerk); jerkCtx.beginPath(); jerkCtx.moveTo(tJx, padding); jerkCtx.lineTo(tJx, 350); jerkCtx.stroke();
                let tGy = getJY(threshG); jerkCtx.beginPath(); jerkCtx.moveTo(padding, tGy); jerkCtx.lineTo(450, tGy); jerkCtx.stroke();
                jerkCtx.setLineDash([]);
                jerkCtx.fillStyle = 'rgba(244, 67, 54, 0.08)';
                jerkCtx.fillRect(tJx, padding, 450 - tJx, tGy - padding);

                thresholdDisplay.style.display = 'block';
                thresholdValues.innerHTML = `
                    <div>Lateral (å·¦å³): <b>${threshGx.toFixed(2)} G</b></div>
                    <div>Longitudinal (å‰å¾Œ): <b>${threshGy.toFixed(2)} G</b></div>
                    <div>Jerk (è¡æ’ƒ): <b>${threshJerk.toFixed(2)} G/s</b></div>
                    <div>Combined (åˆæˆ): <b>${threshG.toFixed(2)} G</b></div>
                `;
            } else {
                thresholdDisplay.style.display = 'none';
                if (dangerC > 0 && dangerC < 20) {
                    document.getElementById('statsDisplay').innerText += " | â€»é–¾å€¤ç®—å‡ºã«ã¯æ“ä½œèµ·å› ã®ä¸å¿«ãƒ‡ãƒ¼ã‚¿ãŒ20ä»¶ä»¥ä¸Šå¿…è¦ã§ã™";
                }
            }

            let msg = `Data: ${processedData.length} | Comfort: ${safeC} | Driver Uncomfort: ${dangerC}`;
            if (useRoadFilter) msg += ` | Road Bump Uncomfort: ${roadC}`;
            document.getElementById('statsDisplay').innerText = msg;
        }

        async function syncFromCloud(isAuto) {
            if (!isAuto) {
                document.getElementById('statsDisplay').innerText = "â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
                syncBtn.disabled = true;
            }
            try {
                const response = await fetch(gasUrl + "?t=" + Date.now());
                if (!response.ok) throw new Error("Server response was " + response.status);

                const data = await response.json();
                if (data && data.length > 0) {
                    rawData = data.map(row => ({
                        time: parseInt(row.time_ms), uncomf: parseInt(row.uncomfortable),
                        rawX: parseFloat(row.rawG_X), rawY: parseFloat(row.rawG_Y), rawZ: parseFloat(row.rawG_Z || 0),
                        jerkZ: parseFloat(row.jerk_Z || 0),
                        jerk: Math.sqrt(parseFloat(row.jerk_X || 0) ** 2 + parseFloat(row.jerk_Y || 0) ** 2),
                        yaw: parseFloat(row.yaw_rad || 0), lat: parseFloat(row.lat || 0), lon: parseFloat(row.lon || 0),
                        age: row.age || 0, exp: row.exp || 0
                    }));
                    rawData.sort((a, b) => a.time - b.time);

                    // Group into Trips based on time gaps (> 1 minute)
                    const GAP_THRESHOLD_MS = 60000;
                    currentTrips = [];
                    if (rawData.length > 0) {
                        let tripStartIdx = 0;
                        for (let i = 1; i < rawData.length; i++) {
                            if (rawData[i].time - rawData[i - 1].time > GAP_THRESHOLD_MS) {
                                // Close current trip
                                currentTrips.push({
                                    id: `trip_${tripStartIdx}`,
                                    startIndex: tripStartIdx,
                                    endIndex: i - 1,
                                    startTime: rawData[tripStartIdx].time,
                                    age: rawData[tripStartIdx].age,
                                    exp: rawData[tripStartIdx].exp
                                });
                                tripStartIdx = i;
                            }
                        }
                        // Add last trip
                        currentTrips.push({
                            id: `trip_${tripStartIdx}`,
                            startIndex: tripStartIdx,
                            endIndex: rawData.length - 1,
                            startTime: rawData[tripStartIdx].time,
                            age: rawData[tripStartIdx].age,
                            exp: rawData[tripStartIdx].exp
                        });
                    }

                    // Update Selector UI
                    const previousSelection = runSelect.value;
                    runSelect.innerHTML = '<option value="all">ã™ã¹ã¦ã®èµ°è¡Œãƒ‡ãƒ¼ã‚¿ (å…¨ä½“ã‚’è¡¨ç¤º)</option>';
                    currentTrips.forEach((t, i) => {
                        const date = new Date(t.startTime);
                        const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
                        const label = `${i + 1}ï¼š${t.age}æ­³/æ­´${t.exp}å¹´ (${timeStr}ã€œ)`;
                        const opt = document.createElement("option");
                        opt.value = t.id;
                        opt.textContent = label;
                        runSelect.appendChild(opt);
                    });
                    if ([...runSelect.options].some(o => o.value === previousSelection)) {
                        runSelect.value = previousSelection;
                    }

                    processAndPlot();
                    if (!isAuto) document.getElementById('statsDisplay').innerText = "âœ… åŒæœŸå®Œäº† (" + rawData.length + " ä»¶)";
                } else {
                    if (!isAuto) document.getElementById('statsDisplay').innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (é…ä¿¡ãªã—)";
                    rawData = []; processAndPlot();
                }
            } catch (e) {
                console.error(e);
                if (!isAuto) document.getElementById('statsDisplay').innerText = "âŒ åŒæœŸå¤±æ•—: " + e.message;
            } finally {
                if (!isAuto) syncBtn.disabled = false;
            }
        }

        // Event Listeners
        autoRefreshCheck.addEventListener('change', () => {
            if (autoRefreshCheck.checked) {
                syncFromCloud(true);
                refreshInterval = setInterval(() => syncFromCloud(true), 5000);
            } else {
                clearInterval(refreshInterval);
            }
        });

        syncBtn.addEventListener('click', () => syncFromCloud(false));
        filterSlider.addEventListener('input', processAndPlot);
        roadFilterCheck.addEventListener('change', processAndPlot);
        gBowlMaxSelect.addEventListener('change', processAndPlot);
        zThresholdSlider.addEventListener('input', processAndPlot);
        lookbackSlider.addEventListener('input', processAndPlot);
        runSelect.addEventListener('change', processAndPlot);
        showSafeCheck.addEventListener('change', processAndPlot);
        showDriverCheck.addEventListener('change', processAndPlot);
        showRoadCheck.addEventListener('change', processAndPlot);

        document.getElementById('resetBtn').addEventListener('click', async () => {
            const pass = prompt("ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (7710)");
            if (!pass || pass !== '7710') { if (pass) alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
            if (!confirm("æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¨è¡ŒãŒæ¶ˆå»ã•ã‚Œã¾ã™)")) return;
            try {
                await fetch(gasUrl, { method: 'POST', mode: 'no-cors', cache: 'no-cache', body: JSON.stringify({ action: 'reset', password: pass }) });
                alert("ãƒªã‚»ãƒƒãƒˆå‘½ä»¤ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚1ã€œ2ç§’å¾…ã£ã¦ã‹ã‚‰åŒæœŸãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                rawData = []; processAndPlot();
            } catch (e) { alert("ãƒªã‚»ãƒƒãƒˆå¤±æ•—: " + e.message); }
        });

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        }

        window.addEventListener('load', async () => {
            await requestWakeLock();
            drawGrids();
            syncFromCloud(false);
        });

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') await requestWakeLock();
        });

        document.addEventListener('touchstart', requestWakeLock, { once: true });
    </script>
</body>

</html>