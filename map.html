<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAP ANALYTICS - Driving App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Outfit:wght@600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #10b981;
            --text: #f8fafc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 15px 15px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            letter-spacing: 1px;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .controls {
            position: absolute;
            top: 70px;
            left: 10px;
            right: 10px;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 250px;
            z-index: 10;
        }

        @media (max-width: 600px) {
            .controls {
                width: calc(100% - 20px);
                max-width: none;
                top: auto;
                bottom: 20px;
            }
        }

        .legend {
            margin-top: 15px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
        }

        #status {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <header>
        <h1>MAP ANALYTICS</h1>
        <div id="status">クラウドからデータを取得中...</div>
    </header>

    <div id="map"></div>

    <div class="controls">
        <button onclick="fetchData()">最新データに更新</button>
        <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 10px;">Jerk Intensity (Heatmap)</div>
        <div class="legend">
            <div class="legend-item">
                <div class="dot" style="background: #10b981;"></div> Smooth (< 0.2 G/s)</div>
                    <div class="legend-item">
                        <div class="dot" style="background: #fbbf24;"></div> Moderate
                    </div>
                    <div class="legend-item">
                        <div class="dot" style="background: #ef4444;"></div> Impact (> 0.5 G/s)
                    </div>
                    <div class="legend-item">
                        <div class="dot" style="background: #a855f7;"></div> Uncomfortable Marker
                    </div>
            </div>
        </div>

        <script>
            const gasUrl = "https://script.google.com/macros/s/AKfycbyza-BCowCNcWYb-63gx1gd4UARcYTeJ8DXqv-rrZwcRryWqfZanAnXfyrf6jFxMEfDIA/exec";
            const API_KEY = "AIzaSyC6sClX278FbJ-mA-OoSU9841M68Ies8PE";
            let map;
            let markers = [];
            let polyline;

            async function initMap() {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=setupMap`;
                script.async = true;
                document.head.appendChild(script);
            }

            function setupMap() {
                const darkStyles = [
                    { "elementType": "geometry", "stylers": [{ "color": "#242f3e" }] },
                    { "elementType": "labels.text.stroke", "stylers": [{ "color": "#242f3e" }] },
                    { "elementType": "labels.text.fill", "stylers": [{ "color": "#746855" }] },
                    { "featureType": "administrative.locality", "elementType": "labels.text.fill", "stylers": [{ "color": "#d59563" }] },
                    { "featureType": "poi", "elementType": "labels.text.fill", "stylers": [{ "color": "#d59563" }] },
                    { "featureType": "poi.park", "elementType": "geometry", "stylers": [{ "color": "#263c3f" }] },
                    { "featureType": "poi.park", "elementType": "labels.text.fill", "stylers": [{ "color": "#6b9a76" }] },
                    { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#38414e" }] },
                    { "featureType": "road", "elementType": "geometry.stroke", "stylers": [{ "color": "#212a37" }] },
                    { "featureType": "road", "elementType": "labels.text.fill", "stylers": [{ "color": "#9ca5b3" }] },
                    { "featureType": "road.highway", "elementType": "geometry", "stylers": [{ "color": "#746855" }] },
                    { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{ "color": "#1f2835" }] },
                    { "featureType": "road.highway", "elementType": "labels.text.fill", "stylers": [{ "color": "#f3d19c" }] },
                    { "featureType": "transit", "elementType": "geometry", "stylers": [{ "color": "#2f3948" }] },
                    { "featureType": "transit.station", "elementType": "labels.text.fill", "stylers": [{ "color": "#d59563" }] },
                    { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#17263c" }] },
                    { "featureType": "water", "elementType": "labels.text.fill", "stylers": [{ "color": "#515c6d" }] },
                    { "featureType": "water", "elementType": "labels.text.stroke", "stylers": [{ "color": "#17263c" }] }
                ];

                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: { lat: 35.6812, lng: 139.7671 },
                    styles: darkStyles,
                    mapTypeControl: false,
                    streetViewControl: true
                });
                fetchData();
            }

            async function fetchData() {
                document.getElementById('status').innerText = "☁️ クラウドからデータを取得中...";
                try {
                    // Add timestamp to bypass cache
                    const response = await fetch(gasUrl + "?type=map&t=" + Date.now());
                    if (!response.ok) throw new Error("Server response was " + response.status);

                    const data = await response.json();
                    if (data && data.length > 0) {
                        plotOnMap(data);
                        document.getElementById('status').innerText = `✅ 同期完了 (${data.length} 件)`;
                    } else {
                        document.getElementById('status').innerText = "⚠️ データが見つかりませんでした (配信なし)";
                        if (polyline) polyline.setMap(null);
                        markers.forEach(m => m.setMap(null));
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('status').innerText = "❌ 同期失敗: " + e.message;
                }
            }

            function plotOnMap(data) {
                if (!map) return;
                if (polyline) polyline.setMap(null);
                markers.forEach(m => m.setMap(null));
                markers = [];

                const path = [];
                let bounds = new google.maps.LatLngBounds();

                data.forEach((row) => {
                    const lat = parseFloat(row.lat);
                    const lon = parseFloat(row.lon);
                    if (isNaN(lat) || isNaN(lon) || (lat === 0 && lon === 0)) return;

                    const pos = { lat, lng: lon };
                    path.push(pos);
                    bounds.extend(pos);

                    const jerk = Math.sqrt(parseFloat(row.jerk_X || 0) ** 2 + parseFloat(row.jerk_Y || 0) ** 2);
                    const uncomf = parseInt(row.uncomfortable);

                    if (uncomf === 1 || jerk > 0.2) {
                        const color = uncomf === 1 ? '#a855f7' : (jerk > 0.5 ? '#ef4444' : '#fbbf24');
                        const marker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: color,
                                fillOpacity: 0.9,
                                strokeWeight: 1,
                                strokeColor: '#fff',
                                scale: uncomf === 1 ? 8 : 5
                            }
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                            <div style="color:black; font-size:12px; font-family:sans-serif;">
                                <b style="font-size:14px;">Driving Detail</b><hr>
                                <b>Jerk:</b> ${jerk.toFixed(3)} G/s<br>
                                <b>Vertical G:</b> ${parseFloat(row.rawG_Z || 0).toFixed(2)}<br>
                                <b>Uncomfort:</b> ${uncomf === 1 ? '<span style="color:red">YES</span>' : 'NO'}
                            </div>
                        `
                        });

                        marker.addListener("click", () => {
                            infoWindow.open(map, marker);
                        });
                        markers.push(marker);
                    }
                });

                polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: "#10b981",
                    strokeOpacity: 0.7,
                    strokeWeight: 4,
                    map: map
                });

                if (path.length > 0) map.fitBounds(bounds);
            }

            window.onload = initMap;
        </script>
</body>

</html>